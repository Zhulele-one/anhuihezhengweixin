<!DOCTYPE html>
<html lang="en"  xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Basic -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Site Metas -->
    <title th:text="${HTML.title}"></title>
    <meta name="keywords" content="安徽和正工程咨询有限公司,和正造价,安徽工程咨询公司">
    <meta name="description" content="安徽和正工程咨询有限公司始建于2016年9月，是一家具有独立法人资格的、新型的现代化企业制公司，企业注册资本1000万元人民币。">
    <meta name="author" content="安徽和正工程咨询有限公司">

    <!-- Site Icons -->
    <link rel="shortcut icon" th:href="@{/hezheng/images/favicon.ico}" type="image/x-icon" />
    <link rel="apple-touch-icon" th:href="@{/hezheng/images/apple-touch-icon.png}">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{/hezheng/css/bootstrap.min.css}">
    <!-- Site CSS -->
    <link rel="stylesheet" th:href="@{/hezheng/style.css}">
    <!-- ALL VERSION CSS -->
    <link rel="stylesheet" th:href="@{/hezheng/css/versions.css}">
    <!-- Responsive CSS -->
    <link rel="stylesheet" th:href="@{/hezheng/css/responsive.css}">
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/hezheng/css/custom.css}">
    <link rel="stylesheet" th:href="@{/hezheng/css/page.css}">
    <link rel="stylesheet" th:href="@{/hezheng/css/mStyle.css}">

    <!--[if lt IE 9]>
    <script th:src="@{https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js}"></script>
    <script th:src="@{https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js}"></script>
    <![endif]-->
    <script th:src="@{/ckeditor/ckeditor.js}"></script>
    <script th:src="@{/ckeditor/config.js}"></script>

</head>
<body class="politics_version">


<div th:insert="~{head/header :: headerFragment}"></div>
<div th:insert="~{head/header :: titleFragment}"></div>

<div id="about" class="section wb hidden-xs hidden-sm">
    <div class="container">
        <div class="row">
            <div class="col-md-3 hidden-xs hidden-sm">
                <div th:insert="~{body/body :: sideFragment}"></div>
            </div><!-- end col -->

            <div class="col-md-9 m40">
                <div class="message-box">
                    <h2 th:text="${HTML.textEntity.title}">公司新闻</h2>
                    <h4 class="caseu" th:text="${HTML.textEntity.alia}">Company Consistent</h4>
                    <hr>

                    <div th:if="${imgText!=null and imgText != ''}">
                        <input id="imgUrl" type="hidden" th:value="${imgText.imgUrl}">
                        <div id="hiddenDiv">
                            <input th:value="${imgText.name}" type="text" id="textTitle" > 标题
                            <input th:value="${imgText.abstractText}" type="text" id="textAbstract"> 概述
                            <div class="form-group">
                                    <button style="width: 85px;" id="pcFilePathBtn" class="btn btn-info grd1" type="button">上传</button>
                                    <p id="pcFilePathName" class="text-left" th:text="${imgText.imgUrl}"></p>

                                    <input name="imgFile" style="display:none" type="file" id="imgFile">

                                    <p class="help-block">请上传标题图片</p>

                                <!--<input th:value="${imgText.imgUrl}" name="imgFile" type="file" id="imgFile"> 标题图片-->
                            </div>
                        </div>
                    </div>

                    <div th:unless="${imgText!=null and imgText!=''}">
                        <div id="hiddenDiv">
                            <input  type="text" id="textTitle" > 标题
                            <input  type="text" id="textAbstract"> 概述
                            <div class="form-group">
                                <button style="width: 85px;" id="pcFilePathBtn" class="btn btn-info grd1" type="button">上传</button>
                                <p id="pcFilePathName" class="text-left" ></p>

                                <input name="imgFile" style="display:none" type="file" id="imgFile">

                                <p class="help-block">请上传标题图片</p>
                                <!--<input name="imgFile" type="file" id="imgFile"> 标题图片-->
                            </div>
                        </div>

                    </div>


                    <div th:utext="${HTML.textEntity.content}" id="editable" contenteditable="true">
                        <h1>你可以在此区域填写内容,加入图片直接拖拽即可(请不要使用工具条中的图片按钮进行上传)</h1>
                    </div>


                    <div class="row">
                        <div class="col-md-4">
                            <button id="submit" class="btn btn-success btn-radius btn-lg btn-block">提交文章</button>
                        </div>
                        <div class="col-md-4">
                            <button id="previewSubmit" class="btn btn-primary btn-lg btn-radius btn-block">生成预览页面</button>
                        </div>
                        <div class="col-md-4">
                            <button id="clearText" class="btn btn-danger btn-lg btn-radius btn-block">清空</button>
                        </div>
                    </div>
                    <hr>
                </div><!-- end messagebox -->
            </div><!-- end col -->
            <hr>
        </div><!-- end row -->
    </div><!-- end container -->
</div><!-- end section -->

<div class="container-fluid visible-sm visible-xs">
    <div class="row">
        <div class="col-md-12 col-xs-12 m40">
            <div class="message-box">
                <h2 th:text="${HTML.textEntity.title}">公司新闻</h2>
                <h4 class="caseu" th:text="${HTML.textEntity.alia}">Company Consistent</h4>
                <hr>
            </div><!-- end messagebox -->
        </div><!-- end col -->
        <hr>
    </div><!-- end row -->
</div><!-- end container -->

<div th:insert="~{head/footer :: footerFragment}"></div>
<div th:insert="~{head/footer :: sidebarFragment}"></div>
<div th:insert="~{head/footer :: totopFragment}"></div>
<div th:insert="~{head/resource :: jsFragment}"></div>
<!--富文本编辑器 设置-->
<script>
    // Turn off automatic editor creation first.
    CKEDITOR.disableAutoInline = true;
    CKEDITOR.inline( 'editable' );
    CKEDITOR.on('instanceReady', function(e) {
        console.log('CKEDITOR初始化', e.editor);

        e.editor.widgets.on('instanceCreated', function(params) {
            console.log('editor创建', params)
        });
        var upload = e.editor.uploadRepository;
        upload.on('instanceCreated', function(eve) {
            //上传前调用
        });
        e.editor.on('change', function(change) {
            console.log('change', change)
        });
        e.editor.on( 'fileUploadRequest', function( evt ) {
            console.log(evt)
        });
        e.editor.on( 'fileUploadResponse', function( evt ) {
            console.log('response',evt)

            // Prevent the default response handler.
            evt.stop();

            // Get XHR and response.
            var data = evt.data;

            if ( response[ 1 ] ) {
                // An error occurred during upload.
                data.message = response[ 1 ];
                evt.cancel();
            } else {
                data.url = response[ 0 ];
            }
        })
        e.editor.on('enableFormSubmit',function (evt) {
            console.log(evt)
        })
        e.editor.on('preventFormSubmit',function (evt) {
            console.log(evt)
        })
    })
</script>

<script>

    $(function () {
        var input = $('#imgFile')
        $('#pcFilePathBtn').click(function () {
            input.click()
        })
        input.change(function () {
            $('#pcFilePathName').html($(this).val())
        })
    })

    $(function () {
        ///提交页面
        let imgUrl = $('#imgUrl').val()
        console.log(imgUrl)
        let textId = [[${textId == null ?0:textId}]];
        let parentId = [[${imgText==null ?0:imgText.id}]];
        let textEntityId = [[${textEntity == null ?0:textEntity.sideId}]]
        let parentTitle = '[[${textEntity == null ?0:textEntity.title}]]'
        console.log(textEntityId);
        console.log(parentTitle);

        let isHaveParent = [[${isHaveParent == null?1:isHaveParent}]]

        if(isHaveParent == 0){
            $('#hiddenDiv').hide()
        }



        $('#submit').click(function () {
            $('.cke_reset').remove();

            let htmlContent = $('#editable').html();
            // let textEntityId = $('#textEntityItem').val();
            // let parentTitle = $("#textEntityItem option:selected").text();
            let textTitle = $('#textTitle').val();
            let textAbstract = $('#textAbstract').val();

            let formData = new FormData();


            if(isHaveParent != 0){
                if(textTitle == null || textTitle == ''){
                    swal({
                        title:"请置顶父页面标题",
                        icon: "info",
                        buttons: "确定",
                    })
                    return false;
                }
                //第一个参数对应后台传参的名字
                formData.append("imgFile",$('#imgFile')[0].files[0]);
            }





            swal({
                title:"你确定要提交吗,提交后将不能更改",
                text: "你指定的父页面是"+ parentTitle,
                icon: "info",
                buttons: ["取消","确定"],
                dangerMode: true,
            }).then((willSubmit) => {
                if (willSubmit) {
                    console.log($('#editable').html());
                    $.ajax({
                        type:"POST",
                        url:"[[@{/preview/previewPage}]]",
                        dataType:"json",
                        data:{
                            content: htmlContent,
                        },success:function(data){
                            if(data.code){
                                $.ajax({
                                    type:"POST",
                                    url:"[[@{/preview/savePage}]]",
                                    dataType:"json",
                                    data:{
                                        id: textId,
                                        title: parentTitle,
                                        textEntityId : textEntityId,
                                        parentId : parentId,
                                        parentTitle : textTitle,
                                        parentAbstract : textAbstract,
                                        imgUrl:imgUrl
                                    },success:function(data){
                                        if(data.code){
                                            $.ajax({
                                                type:"POST",
                                                url:"[[@{/preview/receiveItemImg}]]",
                                                dataType: "json",
                                                contentType: false,
                                                processData: false,
                                                async: false,
                                                data:formData,
                                                success:function(data){
                                                    if(data.code){
                                                        swal({
                                                            title: "保存成功",
                                                            text: data.msg,
                                                            icon: "success",
                                                            button: "确定",
                                                        });
                                                    }else{
                                                        swal({
                                                            title: "提交失败",
                                                            text: data.msg,
                                                            icon: "success",
                                                            button: "确定",
                                                        });
                                                    }
                                                },
                                                error:function(jqXHR){
                                                    swal({
                                                        title: "提交",
                                                        text: "图片为空,将使用无图列表存储",
                                                        icon: "info",
                                                        button: "确定",
                                                    });
                                                }
                                            });
                                        }else{
                                            swal({
                                                title: "保存失败",
                                                text: data.msg,
                                                icon: "success",
                                                button: "确定",
                                            });
                                        }
                                    },
                                    error:function(jqXHR){
                                        swal({
                                            title: "生成",
                                            text: "出错了!输入可能存在问题",
                                            icon: "error",
                                            button: "确定",
                                        });
                                    }
                                });
                            }else{
                                swal({
                                    title: "生成页面失败",
                                    text: data.msg,
                                    icon: "success",
                                    button: "确定",
                                });
                            }
                        },
                        error:function(jqXHR){
                            swal({
                                title: "生成",
                                text: "出错了!输入可能存在问题",
                                icon: "error",
                                button: "确定",
                            });
                        }
                    });
                }
            });

        });

        let previewParentId = textEntityId;

        ///预览页面
        $('#previewSubmit').click(function () {
            // let previewParentId = $('#textEntityItem').val();
            $('.cke_reset').remove();
            var htmlContent = $('#editable').html();
            $.ajax({
                type:"POST",
                url:"[[@{/preview/previewPage}]]",
                dataType:"json",
                data:{
                    content: htmlContent
                },success:function(data){
                    if(data.code){
                        swal({
                            title: "预览页面已生成",
                            icon: "success",
                            button: "确定",
                        }).then((value) => {
                            if(value){
                                window.open(data.msg + "/" + previewParentId);
                                // $('#previewA').empty().append($("<a></a>").attr("href",data.msg).html('点击进入预览页面'))
                            }
                        });
                    }else{
                        swal({
                            title: "生成失败",
                            text: data.msg,
                            icon: "success",
                            button: "确定",
                        });
                    }
                },
                error:function(jqXHR){
                    swal({
                        title: "生成",
                        text: "出错了!输入可能存在问题",
                        icon: "error",
                        button: "确定",
                    });
                }
            });
        });

        $('#clearText').click(function () {
            $('#editable').empty()
        })
    })


</script>

</body>
</html>